<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X Layer Web Browser</title>
    <link rel="icon" href="https://swap.woofingjace.com/image/header/logo.png" type="image/png">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: Arial, sans-serif; background: #fff; color: #202124; min-height: 100vh; display: flex; flex-direction: column; align-items: stretch; padding: 0; }
        .container { width: 100%; display: flex; flex-direction: column; height: 100vh; }
        .logo { width: 120px; height: 60px; object-fit: contain; margin: 5px 10px; display: inline-block; vertical-align: middle; }
        .browser-bar {
            background: #f1f3f4;
            padding: 5px 10px;
            border-bottom: 1px solid #dfe1e5;
            display: flex;
            align-items: center;
            height: 40px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        .nav-buttons { margin-right: 10px; }
        .nav-buttons button {
            background: #fff;
            border: 1px solid #dfe1e5;
            border-radius: 3px;
            padding: 3px 6px;
            margin: 0 3px;
            cursor: pointer;
            font-size: 12px;
            height: 24px;
            min-width: 50px;
        }
        .nav-buttons button:hover { background: #e8eaed; }
        .nav-buttons button:disabled { background: #f1f3f4; color: #9aa0a6; cursor: not-allowed; }
        .address-bar {
            flex: 1;
            display: flex;
            align-items: center;
            background: #fff;
            border: 1px solid #dfe1e5;
            border-radius: 16px;
            padding: 3px 8px;
            box-shadow: 0 1px 1px rgba(0, 0, 0, 0.1);
        }
        .address-bar input {
            flex: 1;
            border: none;
            outline: none;
            font-size: 12px;
            padding: 3px;
            background: transparent;
        }
        .address-bar button {
            background: #4285f4;
            color: #fff;
            border: none;
            border-radius: 3px;
            padding: 3px 8px;
            cursor: pointer;
            font-size: 12px;
            height: 24px;
            min-width: 50px;
        }
        .address-bar button:hover { background: #357abd; }
        .browser-content {
            width: 100%;
            height: calc(100vh - 50px);
            border: none;
            overflow: hidden;
        }
        .status { font-size: 14px; color: #d93025; text-align: center; padding: 10px; }
        .footer { margin-top: 10px; font-size: 12px; color: #70757a; text-align: center; }
        .footer a { color: #1a0dab; text-decoration: none; }
        .footer a:hover { text-decoration: underline; }
        @media (max-width: 600px) {
            .browser-bar { flex-direction: column; padding: 5px; height: auto; }
            .nav-buttons { margin-bottom: 5px; width: 100%; display: flex; justify-content: space-between; }
            .nav-buttons button { flex: 1; margin: 0 2px; }
            .address-bar { width: 100%; margin-top: 5px; }
            .browser-content { height: calc(100vh - 90px); }
            .logo { width: 80px; height: 40px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="browser-bar">
            <img src="https://swap.woofingjace.com/image/header/logo.png" alt="X Layer Web Browser" class="logo">
            <div class="nav-buttons">
                <button id="backButton" disabled>后退</button>
                <button id="forwardButton" disabled>前进</button>
                <button id="refreshButton">刷新</button>
            </div>
            <div class="address-bar">
                <input type="text" id="domainInput" placeholder="输入域名 (例如: 0.OKX)">
                <button id="searchButton">前往</button>
            </div>
        </div>
        <iframe id="browserContent" class="browser-content" src="about:blank"></iframe>
        <div id="status" class="status"></div>
        <div class="footer">
            由 <a href="https://www.okx.com/web3/explorer/xlayer" target="_blank">X Layer</a> 提供支持 | 浏览器 © 2025
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.7.0/dist/web3.min.js"></script>
    <script>
        const resolverContractAddress = '0x323CE1459B33ad71c8997db945Bd690dF07166F0';
        const xLayer = { explorerUrl: 'https://www.okx.com/web3/explorer/xlayer', rpcUrl: 'https://rpc.xlayer.tech' };
        const web3 = new Web3(xLayer.rpcUrl);
        const resolverContract = new web3.eth.Contract([
            {"inputs":[{"internalType":"string","name":"domainName","type":"string"}],"name":"getWalletByDomain","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"string","name":"domainName","type":"string"}],"name":"getUrlByDomain","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"string","name":"domainName","type":"string"}],"name":"getTextByDomain","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"string","name":"domainName","type":"string"}],"name":"isDomainResolved","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"}
        ], resolverContractAddress);

        const contracts = {
            'okb': '0xBf13Ed020DCF22bc8216A23A1167A5dD1fDC2D0E',
            'star': '0xfD809E6c00b7ABD737C3FaDFCaFAF4b6564AF9dD',
            'xdog': '0x68B6387628b4096af034c3a9de3073AB18E744C2',
            'xlayer': '0x70fda345B815EbfceE5a20858F5115126Ca2abF7',
            'OKX': '0xC3ad7bD7e434F4C1C023EbC6fe0AC4705e9518bC', // 支持中文和数字
            'OKX': '0x204fF780E126ADa44B5665a9cBC66925264c8dcB'  // 只支持中文 (覆盖前者，优先级高)
        };

        // 校验中文和数字
        function isChineseOrNumber(str) {
            return /^[\u4e00-\u9fa50-9]+$/.test(str);
        }

        // 校验仅中文
        function isChineseOnly(str) {
            return /^[\u4e00-\u9fa5]+$/.test(str);
        }

        let history = [];
        let currentIndex = -1;

        async function navigateToUrl(domainInput) {
            const iframe = document.getElementById('browserContent');
            const domainInputField = document.getElementById('domainInput');
            const status = document.getElementById('status');
            const backButton = document.getElementById('backButton');
            const forwardButton = document.getElementById('forwardButton');

            try {
                const parts = domainInput.split('.');
                if (parts.length < 2) {
                    status.innerText = "域名格式错误，请包含后缀 (例如: 0.OKX)";
                    iframe.src = 'about:blank';
                    return;
                }
                const suffix = parts[parts.length - 1];
                const prefix = parts.slice(0, -1).join('.');

                const supportedSuffixes = ['okb', 'star', 'xdog', 'xlayer', 'OKX'];
                if (!supportedSuffixes.includes(suffix)) {
                    status.innerText = `不支持的域名后缀。支持的后缀：${supportedSuffixes.join(', ')}`;
                    iframe.src = 'about:blank';
                    return;
                }

                if (suffix === 'OKX') {
                    if (!isChineseOrNumber(prefix)) {
                        status.innerText = "OKX 域名前缀必须为中文或数字";
                        iframe.src = 'about:blank';
                        return;
                    }
                    if (isChineseOnly(prefix) && !contracts['OKX']) {
                        status.innerText = "仅中文 OKX 域名未配置合约";
                        iframe.src = 'about:blank';
                        return;
                    } else if (!isChineseOrNumber(prefix)) {
                        status.innerText = "OKX 域名前缀必须为中文或数字";
                        iframe.src = 'about:blank';
                        return;
                    }
                }

                const isResolved = await resolverContract.methods.isDomainResolved(domainInput).call();
                if (!isResolved) {
                    status.innerText = `未找到域名 "${domainInput}" 的解析记录`;
                    iframe.src = 'about:blank';
                    return;
                }

                const url = await resolverContract.methods.getUrlByDomain(domainInput).call();
                if (!url || url === "") {
                    status.innerText = "未找到有效网址";
                    iframe.src = 'about:blank';
                    return;
                }

                // 更新历史记录
                if (currentIndex < history.length - 1) {
                    history = history.slice(0, currentIndex + 1);
                }
                history.push(url);
                currentIndex++;

                // 地址栏显示域名，iframe 加载实际 URL
                domainInputField.value = domainInput;
                iframe.src = url;
                status.innerText = "";
                backButton.disabled = currentIndex <= 0;
                forwardButton.disabled = currentIndex >= history.length - 1;
            } catch (error) {
                console.error("Error details:", error);
                status.innerText = "查询失败: " + (error.message.includes('revert') ? error.message.split('revert')[1]?.trim() || '未知原因' : error.message);
                iframe.src = 'about:blank';
            }
        }

        function goBack() {
            if (currentIndex > 0) {
                currentIndex--;
                document.getElementById('browserContent').src = history[currentIndex];
                updateNavigationButtons();
            }
        }

        function goForward() {
            if (currentIndex < history.length - 1) {
                currentIndex++;
                document.getElementById('browserContent').src = history[currentIndex];
                updateNavigationButtons();
            }
        }

        function refresh() {
            const iframe = document.getElementById('browserContent');
            if (iframe.src !== 'about:blank') {
                iframe.contentWindow.location.reload();
            }
        }

        function updateNavigationButtons() {
            const backButton = document.getElementById('backButton');
            const forwardButton = document.getElementById('forwardButton');
            backButton.disabled = currentIndex <= 0;
            forwardButton.disabled = currentIndex >= history.length - 1;
        }

        document.addEventListener('DOMContentLoaded', () => {
            const domainInput = document.getElementById('domainInput');
            const searchButton = document.getElementById('searchButton');
            const backButton = document.getElementById('backButton');
            const forwardButton = document.getElementById('forwardButton');
            const refreshButton = document.getElementById('refreshButton');

            searchButton.addEventListener('click', () => {
                const domainInputValue = domainInput.value.trim();
                navigateToUrl(domainInputValue);
            });

            domainInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const domainInputValue = domainInput.value.trim();
                    navigateToUrl(domainInputValue);
                }
            });

            backButton.addEventListener('click', goBack);
            forwardButton.addEventListener('click', goForward);
            refreshButton.addEventListener('click', refresh);
        });
    </script>
</body>
</html>
